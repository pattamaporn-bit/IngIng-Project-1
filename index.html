<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>School RFID Attendance V3.1 (Date & Time)</title>
    <style>
        body { font-family: 'Sarabun', 'Segoe UI', sans-serif; max-width: 900px; margin: 2rem auto; padding: 0 1rem; background-color: #f0f2f5; }
        .container { background: white; padding: 2rem; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); margin-bottom: 20px; }
        h1, h2 { color: #2c3e50; text-align: center; margin-bottom: 1.5rem; }
        
        /* Input Styling */
        .form-group { margin-bottom: 10px; }
        input[type="text"], select, input[type="file"] { width: 100%; padding: 12px; margin: 5px 0; border: 2px solid #e1e4e8; border-radius: 6px; box-sizing: border-box; font-size: 16px; }
        input[type="text"]:focus, select:focus { border-color: #4CAF50; outline: none; }
        
        button { width: 100%; padding: 14px; background-color: #4CAF50; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 16px; font-weight: bold; transition: background 0.2s; }
        button:hover { background-color: #45a049; }
        
        /* Status Messages */
        #status { margin-top: 1rem; padding: 15px; border-radius: 6px; text-align: center; display: none; font-weight: bold; font-size: 1.1em; }
        .success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }

        /* Tables */
        table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 0.95rem; }
        th, td { text-align: left; padding: 15px; border-bottom: 1px solid #eee; vertical-align: middle; }
        th { background-color: #4CAF50; color: white; border-radius: 6px 6px 0 0; }
        tr:last-child td { border-bottom: none; }
        
        /* Profile Image Styles */
        .profile-pic { width: 50px; height: 50px; border-radius: 50%; object-fit: cover; border: 2px solid #ddd; }
        .no-pic { width: 50px; height: 50px; border-radius: 50%; background: #eee; display: flex; align-items: center; justify-content: center; font-size: 20px; color: #999; }

        /* Admin Section Style */
        .admin-box { border: 2px dashed #cbd5e0; background-color: #f8fafc; }
        .admin-title { color: #64748b; font-size: 0.85em; text-transform: uppercase; letter-spacing: 1.5px; font-weight: bold; margin-bottom: 15px; }
        
        /* Grid for Form */
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        @media (max-width: 600px) { .form-grid { grid-template-columns: 1fr; } }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600&display=swap" rel="stylesheet">
</head>
<body>

<div class="container">
    <h1>üè´ ‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô (Daily Attendance)</h1>
    
    <p style="text-align:center; color:#666;">‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡∏ä‡πà‡∏≠‡∏á‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á‡πÅ‡∏•‡πâ‡∏ß‡∏™‡πÅ‡∏Å‡∏ô‡∏ö‡∏±‡∏ï‡∏£</p>
    <input type="text" id="attendanceInput" placeholder="Scan RFID tag here..." autofocus autocomplete="off">
    
    <div id="status"></div>

    <h3>üïí ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î (Live Log)</h3>
    <table id="attendanceTable">
        <thead>
            <tr>
                <th>‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û</th>
                <th>‡∏ß‡∏±‡∏ô-‡πÄ‡∏ß‡∏•‡∏≤ ‡∏ó‡∏µ‡πà‡πÅ‡∏ï‡∏∞‡∏ö‡∏±‡∏ï‡∏£</th> <th>‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</th>
                <th>‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</th>
                <th>‡∏£‡∏´‡∏±‡∏™‡∏ö‡∏±‡∏ï‡∏£</th>
            </tr>
        </thead>
        <tbody>
            </tbody>
    </table>
</div>

<div class="container admin-box">
    <div class="admin-title">Teacher Control Panel</div>
    <h2>‚ûï ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÉ‡∏´‡∏°‡πà</h2>
    
    <div class="form-grid">
        <input type="text" id="regName" placeholder="‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏• (‡πÄ‡∏ä‡πà‡∏ô ‡∏î.‡∏ä.‡∏™‡∏°‡∏ä‡∏≤‡∏¢)">
        <select id="regGrade">
            <option value="" disabled selected>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô</option>
            <option value="‡∏õ.1">‡∏õ‡∏£‡∏∞‡∏ñ‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏õ‡∏µ‡∏ó‡∏µ‡πà 1</option>
            <option value="‡∏õ.2">‡∏õ‡∏£‡∏∞‡∏ñ‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏õ‡∏µ‡∏ó‡∏µ‡πà 2</option>
            <option value="‡∏õ.3">‡∏õ‡∏£‡∏∞‡∏ñ‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏õ‡∏µ‡∏ó‡∏µ‡πà 3</option>
            <option value="‡∏õ.4">‡∏õ‡∏£‡∏∞‡∏ñ‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏õ‡∏µ‡∏ó‡∏µ‡πà 4</option>
            <option value="‡∏õ.5">‡∏õ‡∏£‡∏∞‡∏ñ‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏õ‡∏µ‡∏ó‡∏µ‡πà 5</option>
            <option value="‡∏õ.6">‡∏õ‡∏£‡∏∞‡∏ñ‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏õ‡∏µ‡∏ó‡∏µ‡πà 6</option>
            <option value="‡∏Ñ‡∏£‡∏π">‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏£‡∏π/‡∏ö‡∏∏‡∏Ñ‡∏•‡∏≤‡∏Å‡∏£</option>
        </select>
    </div>

    <label style="display:block; margin-top:10px; font-size:0.9em; color:#555;">‡∏£‡∏π‡∏õ‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå:</label>
    <input type="file" id="regPhoto" accept="image/*">

    <input type="text" id="regTag" placeholder="‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà ‡πÅ‡∏•‡πâ‡∏ß‡∏™‡πÅ‡∏Å‡∏ô‡∏ö‡∏±‡∏ï‡∏£‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô..." style="background-color: #fffde7;">
    
    <button onclick="registerStudent()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</button>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getFirestore, collection, addDoc, setDoc, doc, onSnapshot, query, orderBy, limit, serverTimestamp } 
    from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyDMtI_itTZUTAHB9F0DfSq_tr9eRA_HiA0",
  authDomain: "inging-attendance.firebaseapp.com",
  projectId: "inging-attendance",
  storageBucket: "inging-attendance.firebasestorage.app",
  messagingSenderId: "573586079577",
  appId: "1:573586079577:web:d5ed2353ee458f22d95648"
};
  // ----------------------------------------

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  // --- 1. HELPER: CONVERT IMAGE TO BASE64 ---
  const toBase64 = file => new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.readAsDataURL(file);
      reader.onload = () => resolve(reader.result);
      reader.onerror = error => reject(error);
  });

  // --- 2. STUDENT DIRECTORY ---
  let studentDirectory = {}; 

  onSnapshot(collection(db, "students"), (snapshot) => {
      snapshot.forEach((doc) => {
          const d = doc.data();
          studentDirectory[doc.id] = {
              name: d.name,
              grade: d.grade || "N/A",
              photo: d.photo || null 
          };
      });
      console.log("Directory updated:", Object.keys(studentDirectory).length + " students loaded.");
  });

  // --- 3. REGISTRATION LOGIC ---
  window.registerStudent = async function() {
      const name = document.getElementById('regName').value.trim();
      const grade = document.getElementById('regGrade').value;
      const tagId = document.getElementById('regTag').value.trim();
      const photoFile = document.getElementById('regPhoto').files[0];

      if (!name || !tagId || !grade) {
          alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠, ‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ô ‡πÅ‡∏•‡∏∞‡∏™‡πÅ‡∏Å‡∏ô‡∏ö‡∏±‡∏ï‡∏£!");
          return;
      }

      if (photoFile && photoFile.size > 500 * 1024) {
          alert("‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÉ‡∏´‡∏ç‡πà‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ! ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏ä‡πâ‡πÑ‡∏ü‡∏•‡πå‡∏Ç‡∏ô‡∏≤‡∏î‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 500KB");
          return;
      }

      let photoBase64 = null;
      if (photoFile) {
          try {
              photoBase64 = await toBase64(photoFile);
          } catch(e) {
              console.error("Error processing image", e);
              alert("Error processing image file.");
              return;
          }
      }

      try {
          await setDoc(doc(db, "students", tagId), {
              name: name,
              grade: grade,
              photo: photoBase64,
              registeredAt: serverTimestamp()
          });
          
          alert(`‚úÖ ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ${name} (${grade})`);
          document.getElementById('regName').value = '';
          document.getElementById('regGrade').value = '';
          document.getElementById('regTag').value = '';
          document.getElementById('regPhoto').value = ''; 
      } catch (e) {
          console.error("Error: ", e);
          alert("‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô");
      }
  }

  // --- 4. ATTENDANCE LOGIC ---
  const attendanceInput = document.getElementById('attendanceInput');
  const statusDiv = document.getElementById('status');

  attendanceInput.addEventListener('keypress', async (e) => {
      if (e.key === 'Enter') {
          const tagId = attendanceInput.value.trim();
          if (tagId) {
              await markAttendance(tagId);
              attendanceInput.value = ''; 
          }
      }
  });

  async function markAttendance(id) {
      const student = studentDirectory[id];
      
      const studentName = student ? student.name : "‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô";
      const studentGrade = student ? student.grade : "--";
      const studentPhoto = student ? student.photo : null;

      // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏ó‡∏±‡∏ô‡∏ó‡∏µ (Client side)
      const now = new Date();
      const timeString = now.toLocaleTimeString('th-TH');

      try {
          await addDoc(collection(db, "attendance"), {
              tag_id: id,
              student_name: studentName,
              student_grade: studentGrade,
              student_photo: studentPhoto,
              timestamp: serverTimestamp()
          });
          
          if(student) {
              // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÉ‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
              showStatus(`‚úÖ ‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö, ${studentName}!<br>‚è∞ ‡πÄ‡∏ß‡∏•‡∏≤: ${timeString}`, "success");
          } else {
              showStatus(`‚ö†Ô∏è ‡∏ö‡∏±‡∏ï‡∏£‡∏ô‡∏µ‡πâ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô: ${id}`, "error");
          }
      } catch (e) {
          console.error(e);
          showStatus("‚ùå System Error.", "error");
      }
  }

  function showStatus(msg, type) {
      statusDiv.innerHTML = msg; // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô innerHTML ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ <br> ‡πÑ‡∏î‡πâ
      statusDiv.className = type;
      statusDiv.style.display = 'block';
      
      // ‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÉ‡∏´‡πâ‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏≤‡∏¢‡πÑ‡∏õ‡∏´‡∏•‡∏±‡∏á 4 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
      setTimeout(() => { statusDiv.style.display = 'none'; }, 4000);
  }

  // --- 5. SHOW TABLE ---
  const q = query(collection(db, "attendance"), orderBy("timestamp", "desc"), limit(10));
  
  onSnapshot(q, (snapshot) => {
      const tbody = document.querySelector('#attendanceTable tbody');
      tbody.innerHTML = ''; 
      
      snapshot.forEach((doc) => {
          const data = doc.data();
          
          // --- ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏ß‡∏•‡∏≤‡πÅ‡∏•‡∏∞‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ---
          let dateStr = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...";
          if (data.timestamp) {
              const dateObj = data.timestamp.toDate();
              // ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö: 29/01/2024 10:30:45
              dateStr = dateObj.toLocaleString('th-TH', {
                  year: 'numeric', 
                  month: '2-digit', 
                  day: '2-digit', 
                  hour: '2-digit', 
                  minute:'2-digit', 
                  second:'2-digit'
              });
          }
          // --------------------------------------

          let imgHtml = `<div class="no-pic">?</div>`;
          if (data.student_photo) {
              imgHtml = `<img src="${data.student_photo}" class="profile-pic">`;
          }

          const row = `<tr>
              <td>${imgHtml}</td>
              <td style="font-weight:bold; color:#0056b3;">${dateStr}</td> <td style="font-weight:bold; color:#333;">${data.student_name || "Unknown"}</td>
              <td><span style="background:#e8f5e9; padding:4px 8px; border-radius:10px; font-size:0.85em; color:#2e7d32;">${data.student_grade || "N/A"}</span></td>
              <td style="color:#999; font-size:0.85em;">${data.tag_id}</td>
          </tr>`;
          tbody.innerHTML += row;
      });
  });
</script>

</body>
</html>
